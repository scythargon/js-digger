<script src="lib/jquery-1.9.1.min.js"></script>
<script src="lib/jquery-ui.js"></script>
<script src="lib/keyboard.js"></script>
<script src="lib/jquery.jrumble.1.3.min.js"></script>
<script src="lib/jquery-collision.js"></script>

<script src="src/Settings.js"></script>
<script src="src/Entity.js"></script>
<script src="src/Battlefield.js"></script>
<script src="src/Unit.js"></script>
<script src="src/Hero.js"></script>

<style>
    html, body, table, tr, td {
        width: 100%;
        table-layout: fixed;
        padding: 0;
        margin: 0;
    }

    body {
        background: white;
    }

    .battlefield {
    }

    table {
        height: 100%;
        border: 0;
        border-collapse: collapse;
    }

    tr {
        background: rgb(255, 255, 127);
        margin: 0;
        padding: 0;
    }

    td {
        background: rgb(127, 255, 255);
        margin: 0;
        padding: 0;
        box-shadow: inset 0 0 10px #000000;
    }

    .unit {
        z-index: 1;
        position: absolute;
        box-shadow: inset 0 0 10px #000000;
        left: 0;
        top: 0;
    }

    #hero {
        background: #00ff00;
    }

    .rock {
        background: brown;
    }

    .gem, .gold, .gold-fallen {
        border-radius: 50%;
        text-align: center;
        vertical-align: middle;
    }

    .gem {
        background: pink;
    }

    .gold {
        background: yellow;
    }

    .gold-fallen {
        background: orange;
    }

    .gold-falling {
        background: red ! important;
    }

    #stats {
        background: blue;
        height: 20px;
        color: white;
    }
</style>
<body>
<div id="stats">gems: <span id='score'>0</span> gold: <span id='score-gold'>0</span> lives: <span id='lives'>3</span>
</div>
<div id="battlefield"></div>
<div style="display:none;" class="resources">
    <div id="hero" class="unit"></div>
    <div class="rock unit"></div>
    <div class="gem unit consume"></div>
    <div class="gold unit push"><span>G</span></div>
    <div class="gold-fallen unit consume"><span>G</span></div>
</div>
</body>

<script type="text/javascript">
    var settings = new Settings();

    var bf = new Battlefield(settings.cells_x, settings.cells_y);

    var hero = new Hero(1,1);
    hero.$dom.appendTo(bf.dom);

    var cell = $('#battlefield > table > tr:first > td:first');
    $('.unit').width(cell.width());
    $('.unit').height(cell.height());

    $('.gold, .gold-fallen').width(cell.width() / 2);
    $('.gold, .gold-fallen').height(cell.height() / 2);




    setInterval(gameLoop, 100);


    function gameLoop() {
        checkCollisionWithGold();
        getPressedKeys();
    }

    function checkCollisionWithGold(){
        var collisions = $("#hero").collision( ".gold-falling", { relative: "collider", obstacleData: "odata", colliderData: "cdata", directionData: "ddata", as: "<div/>" } )
        var hit_area = 0;
        for( var i=0; i<collisions.length; i++ )
        {
            var o = $(collisions[i]).data("odata");
            var c = $(collisions[i]).data("cdata");
            var d = $(collisions[i]).data("ddata");
            var cwith = $(o).get(0).id;
            var cside = d;
            var snap  = $(c);
            var collided = $( collisions[ i ] );
            hit_area += collided.width() * collided.height();
        }


        if ( hit_area > ( cell.width() * cell.height() / 10 ) ) {
            console.log(hit_area);
            hitByGold();
        }
    }
    function hitByGold(){
        debug( 2, "hit by gold" );
        var lives = parseInt($('#lives').html());
        lives--;
        $('#lives').html(lives);
        hero.reset();
    }

    function getPressedKeys() {
        var activeKeys = KeyboardJS.activeKeys();
        //console.log(activeKeys);
        if ($.inArray("right", activeKeys) >= 0) {
            hero.move("right");
        }
        else if ($.inArray("left", activeKeys) >= 0) {
            hero.move("left");
        }
        else if ($.inArray("up", activeKeys) >= 0) {
            hero.move("up");
        }
        else if ($.inArray("down", activeKeys) >= 0) {
            hero.move("down");
        }
    }


    function tryPush(x, y, item) {
        if (item[0].x + x < 0 || item[0].x + x == settings.cells_x || item[0].y + y < 0 || item[0].y + y == settings.cells_y) {

            //return true;
        }
        var animation_speed = settings.animation_speed;
        var animation_type = settings.animation_type_fall;
        if (!(item[0].x + x < 0 || item[0].x + x == settings.cells_x || item[0].y + y < 0 || item[0].y + y == settings.cells_y))//если не граница
        {
            item.animate({"top": "+=" + cell.height() * y + "px", "left": "+=" + cell.width() * x + "px"}, {duration: animation_speed, easing: animation_type, complete: function () {
                bf.removeItems(item[0].x, item[0].y, item); //TODO OMG
                item.changeY(y);
                item.changeX(x);
                bf.addItems(item[0].x, item[0].y, item);
                if (bf.cellContains(item[0].x, item[0].y + 1, ".rock") == 0) {
                    item.fall();
                }
            }});
        }
        return true;
    }
    var Replace = null;
    var Fallen = null;
    bf.generateRandomItems(0.2, 'rock');
    bf.generateRandomItems(0.5, 'gem');
    bf.generateRandomItems(0.8, 'gold');
    function rand(arg) {
        return Math.random() > arg;
    }

    (function ($) {

        $.fn.changeX = function (x) {
            return this.each(function () {
                this.x += x;
            });
        };

        $.fn.changeY = function (y) {
            return this.each(function () {
                this.y += y;
            });
        };
        $.fn.fall = function () {
            var animation_speed = settings.animation_speed;
            var animation_type = settings.animation_type_fall;
            if (this.size() == 0) {
                debug(1, 'empty collection');
                return this;
            }
            var item = this;

            setG(item);
            if (bf.cellContains(item[0].x, item[0].y + 1, ".rock") == 0) {
                debug(2, 'lets fall');
                //item.effect("highlight", {color: 'red'}, 3000);

                item.addClass('gold-falling');
                item.animate({"top": "+=" + cell.height() + "px"}, {duration: animation_speed, easing: animation_type, queue: false, complete: function () {
                    bf.removeItems(item[0].x, item[0].y, item);
                    item.changeY(1);
                    bf.addItems(item[0].x, item[0].y, item);
                    debug(0, 'add fallen');

                    item.fall();
                }})
                .effect("pulsate", { times:3 }, animation_speed);
            } else {
                debug(2, 'there are rock under gold, do not fall');
                item.removeClass('gold-falling')
                item.each(function () {
                    $item = $(this);
                    var fallen = $('.resources > .gold-fallen').clone();
                    fallen.offset($item.offset());
                    $item.replaceWith(fallen);
                    bf.addItems(item[0].x, item[0].y, fallen);
                });

                bf.removeItemsByClass(item[0].x, item[0].y, ".gold");

            }
        };

    })(jQuery);


</script>